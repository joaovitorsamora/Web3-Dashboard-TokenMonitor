<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SRC Token Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0d0d0d;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    .card {
      background: #1a1a1a;
      padding: 20px;
      margin-top: 20px;
      border-radius: 14px;
      box-shadow: 0px 0px 14px rgba(255,255,255,0.05);
    }
    h2 { margin-top: 0; }
    button {
      padding: 12px 18px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    button.primary { background: #4caf50; color: #fff; }
    button.danger { background: #d9534f; color: #fff; }
    button.action { background: #0275d8; color: #fff; }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      margin-top: 10px;
      margin-bottom: 10px;
      background: #333;
      color: #fff;
      font-size: 15px;
    }

    .row { display: flex; gap: 20px; }
    .col { flex: 1; }

    .loader {
      border: 4px solid rgba(255,255,255,0.1);
      border-left-color: #4caf50;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
<div class="container">

  <h1>SRC Dashboard</h1>
  <p>Interaja com o token baseado em volume de buscas.</p>

  <button id="connectWallet" class="action">Conectar Wallet</button>

  <!-- Token Status -->
  <div class="card" id="statusCard">
    <h2>ðŸ“Š Status do Token</h2>
    <p><strong>PreÃ§o:</strong> <span id="price">Carregando...</span></p>
    <p><strong>Valuation:</strong> <span id="valuation">Carregando...</span></p>
    <p><strong>Volume de Busca:</strong> <span id="searchVolume">Carregando...</span></p>
    <p><strong>Supply Total:</strong> <span id="supply">Carregando...</span></p>
  </div>

  <div class="row">

    <!-- Buy -->
    <div class="card col">
      <h2>ðŸŸ¢ Comprar SRC</h2>
      <input id="buyAmount" placeholder="USDT a gastar (6 decimais)" />
      <button class="primary" onclick="buySRC()">Comprar</button>
    </div>

    <!-- Sell -->
    <div class="card col">
      <h2>ðŸ”´ Vender SRC</h2>
      <input id="sellAmount" placeholder="SRC a vender (18 decimais)" />
      <button class="danger" onclick="sellSRC()">Vender</button>
    </div>

  </div>

  <!-- STAKING -->
  <div class="card">
    <h2>ðŸ’  Staking</h2>
    <p>VocÃª tem: <span id="staked">Carregando...</span> SRC staked.</p>
    <p>Recompensas acumuladas: <span id="rewards">Carregando...</span></p>

    <input id="stakeAmount" placeholder="Quantos SRC deseja stakear?" />
    <button class="primary" onclick="stake()">Stake</button>

    <input id="unstakeAmount" placeholder="Quantos SRC deseja remover?" />
    <button class="danger" onclick="unstake()">Unstake</button>
  </div>

</div>

<script>

const SRC_ADDRESS = "0xE755051657099d1cA2AaBACf98A3A0848c43C851";
const USDT_ADDRESS = "0x7eF95A0fE463B3F2681b76234E8C99f56C0C8F5E";

// ABI COMPLETO (gerado do seu contrato final)
const SRC_ABI = [
  { "inputs":[
      {"internalType":"uint256","name":"initialSupply","type":"uint256"},
      {"internalType":"address","name":"_quoteToken","type":"address"},
      {"internalType":"address","name":"_trustedOracle","type":"address"},
      {"internalType":"address","name":"_searchVolumeFeed","type":"address"}
    ],
    "stateMutability":"nonpayable",
    "type":"constructor"
  },

  {"anonymous":false,"inputs":[
    {"indexed":false,"internalType":"uint256","name":"newValuation","type":"uint256"},
    {"indexed":false,"internalType":"uint256","name":"newSearchVolume","type":"uint256"},
    {"indexed":true,"internalType":"address","name":"updater","type":"address"}
  ],"name":"ValuationUpdated","type":"event"},

  {"inputs":[],"name":"buy","outputs":[],"stateMutability":"nonpayable","type":"function"},

  {"inputs":[{"internalType":"uint256","name":"srcAmount","type":"uint256"}],
   "name":"sell","outputs":[],"stateMutability":"nonpayable","type":"function"},

  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],
   "name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},

  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],
   "name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"},

  {"inputs":[{"internalType":"address","name":"user","type":"address"}],
   "name":"calculateRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],
   "stateMutability":"view","type":"function"},

  {"inputs":[],"name":"currentValuation","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"currentSearchVolume","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getCurrentPrice","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalSupply","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"stakes","outputs":[
    {"type":"uint256"},{"type":"uint256"}],
    "stateMutability":"view","type":"function"
  }
];

let provider, signer, walletAddress, src, usdt;

document.getElementById("connectWallet").onclick = connectWallet;

async function connectWallet() {
  if (!window.ethereum) {
    Swal.fire("Wallet nÃ£o encontrada", "Instale MetaMask", "error");
    return;
  }

  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  walletAddress = await signer.getAddress();

  src = new ethers.Contract(SRC_ADDRESS, SRC_ABI, signer);

  Swal.fire("Wallet conectada!", walletAddress, "success");

  loadAll();
}

// -------------------- LOADING --------------------

async function loadAll() {
  loadStatus();
  loadStake();
}

async function loadStatus() {
  const price = await src.getCurrentPrice();
  const val = await src.currentValuation();
  const sv = await src.currentSearchVolume();
  const sup = await src.totalSupply();

  document.getElementById("price").innerText = (Number(price) / 1e18).toFixed(8) + " USDT";
  document.getElementById("valuation").innerText = val.toString();
  document.getElementById("searchVolume").innerText = sv.toString();
  document.getElementById("supply").innerText = sup.toString();
}

async function loadStake() {
  const data = await src.stakes(walletAddress);
  const rewards = await src.calculateRewards(walletAddress);

  document.getElementById("staked").innerText = data[0].toString();
  document.getElementById("rewards").innerText = rewards.toString();
}

// -------------------- BUY --------------------

async function buySRC() {
  const amount = document.getElementById("buyAmount").value;
  if (!amount) return;

  try {
    const tx = await src.buy(BigInt(amount));
    Swal.fire("Processando compra...", "", "info");
    await tx.wait();
    Swal.fire("Compra feita!", "", "success");
    loadAll();
  } catch (err) {
    Swal.fire("Erro", err.message, "error");
  }
}

// -------------------- SELL --------------------

async function sellSRC() {
  const amount = document.getElementById("sellAmount").value;
  if (!amount) return;

  try {
    const tx = await src.sell(BigInt(amount));
    Swal.fire("Processando venda...", "", "info");
    await tx.wait();
    Swal.fire("Venda feita!", "", "success");
    loadAll();
  } catch (err) {
    Swal.fire("Erro", err.message, "error");
  }
}

// -------------------- STAKE --------------------

async function stake() {
  const amount = document.getElementById("stakeAmount").value;
  if (!amount) return;

  try {
    const tx = await src.stake(BigInt(amount));
    Swal.fire("Stake realizado!", "", "success");
    await tx.wait();
    loadAll();
  } catch (err) {
    Swal.fire("Erro", err.message, "error");
  }
}

// -------------------- UNSTAKE --------------------

async function unstake() {
  const amount = document.getElementById("unstakeAmount").value;
  if (!amount) return;

  try {
    const tx = await src.unstake(BigInt(amount));
    Swal.fire("Unstake realizado!", "", "success");
    await tx.wait();
    loadAll();
  } catch (err) {
    Swal.fire("Erro", err.message, "error");
  }
}

</script>

</body>
</html>
